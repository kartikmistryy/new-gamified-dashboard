---
phase: 04-remaining-tabs
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/teamDashboard/spofMockData.ts
  - lib/teamDashboard/spofHelpers.ts
  - app/org/[orgId]/team/[teamId]/spof/page.tsx
autonomous: true

must_haves:
  truths:
    - "SPOF tab shows D3Gauge with team SPOF risk score"
    - "SPOF tab shows SpofDistributionChart with member SPOF data points"
    - "SPOF tab shows RepoHealthBar with member repository health distribution"
    - "SPOF tab member table has SPOF score, risk level, and repo health columns"
    - "Filter tabs sort members by SPOF risk and repo health"
    - "ChartInsights panel shows member-level SPOF risk insights"
  artifacts:
    - path: "lib/teamDashboard/spofMockData.ts"
      provides: "Member SPOF mock data generator"
      exports: ["getMemberSpofData", "getMemberSpofDataPoints"]
    - path: "lib/teamDashboard/spofHelpers.ts"
      provides: "SPOF tab filter logic and insights"
      exports: ["getSpofInsights"]
    - path: "app/org/[orgId]/team/[teamId]/spof/page.tsx"
      provides: "SPOF tab page composition"
      contains: "SpofDistributionChart"
  key_links:
    - from: "app/org/[orgId]/team/[teamId]/spof/page.tsx"
      to: "lib/teamDashboard/spofMockData.ts"
      via: "import and useMemo"
      pattern: "getMemberSpofData"
    - from: "app/org/[orgId]/team/[teamId]/spof/page.tsx"
      to: "components/dashboard/SpofDistributionChart.tsx"
      via: "data and visibleTeams props"
      pattern: "SpofDistributionChart.*data="
    - from: "app/org/[orgId]/team/[teamId]/spof/page.tsx"
      to: "components/dashboard/RepoHealthBar.tsx"
      via: "data prop with member repo health"
      pattern: "RepoHealthBar"
    - from: "app/org/[orgId]/team/[teamId]/spof/page.tsx"
      to: "components/dashboard/D3Gauge.tsx"
      via: "value prop with team SPOF score"
      pattern: "D3Gauge.*value="
---

<objective>
Implement the SPOF tab for the team dashboard, showing member-level single-point-of-failure risk distribution and repository health analysis.

Purpose: Enable users to identify which team members represent SPOF risks based on code ownership concentration, mirroring the org dashboard SPOF tab layout with member-level data.
Output: Working SPOF tab at `/org/:orgId/team/:teamId/spof` with D3Gauge, SpofDistributionChart, RepoHealthBar, BaseTeamsTable, and ChartInsights.
</objective>

<execution_context>
@/Users/kartikmistry/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kartikmistry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-remaining-tabs/04-RESEARCH.md

@app/org/[orgId]/spof/page.tsx
@app/org/[orgId]/team/[teamId]/performance/page.tsx
@lib/teamDashboard/overviewMockData.ts
@lib/teamDashboard/types.ts
@lib/orgDashboard/spofMockData.ts
@lib/orgDashboard/types.ts
@components/dashboard/SpofDistributionChart.tsx
@components/dashboard/RepoHealthBar.tsx
@components/dashboard/D3Gauge.tsx
@components/dashboard/BaseTeamsTable.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SPOF mock data generator and helpers</name>
  <files>
    lib/teamDashboard/spofMockData.ts
    lib/teamDashboard/spofHelpers.ts
  </files>
  <action>
Create `lib/teamDashboard/spofMockData.ts`:

1. Define `MemberSpofRow` type:
   - `memberName: string`, `teamId: string`
   - `avgSpofScore: number` (0-6 scale, average of member's SPOF data points)
   - `domainCount: number` (1-5 domains member contributes to)
   - `skillCount: number` (3-15 skills)
   - `repoCount: number` (repos member has committed to)
   - `highRiskCount: number` (repos where member is sole contributor, score > 2.2)
   - `lowRiskCount: number` (well-distributed repos, score < 0.2)
   - `repoHealthHealthy: number`, `repoHealthNeedsAttention: number`, `repoHealthCritical: number`
   - `memberColor: string` (for chart legend, use DASHBOARD_COLORS cycle)

2. Create `getMemberSpofData(teamId: string, memberCount?: number)` function:
   - Reuse `getMemberPerformanceRowsForTeam(52, teamId, memberCount)` for base member names
   - Generate deterministic SPOF metrics using `Math.sin(seed * 9999)` noise pattern
   - Use member name charCode + index as seed
   - Generate `avgSpofScore` in 0.3-4.5 range (varied distribution)
   - `domainCount` 1-5, `skillCount` 3-15, `repoCount` 5-25
   - `highRiskCount`: derived from avgSpofScore (higher SPOF = more high-risk repos)
   - `lowRiskCount`: inverse relationship to avgSpofScore
   - Repo health: distribute repoCount across healthy/needsAttention/critical buckets deterministically
   - Assign `memberColor` cycling through DASHBOARD_COLORS array (6 colors for 6 members)

3. Create `getMemberSpofDataPoints(members: MemberSpofRow[])` function:
   - Returns `SpofDataPoint[]` (matching SpofDistributionChart's expected format from `@/lib/orgDashboard/spofMockData`)
   - For each member, generate 8-20 data points with SPOF scores clustered around their avgSpofScore
   - Each point: `{ score: number, team: memberName }` — use member name in `team` field (chart groups by this)
   - Use deterministic generation: `memberAvgScore + (noise(seed + i) - 0.5) * 2` clamped to [0, 6]
   - Total ~60-80 data points across all members for good histogram resolution

4. Create `calculateTeamSpofGaugeValue(members: MemberSpofRow[])`:
   - Returns a 0-100 score for D3Gauge
   - Calculate as weighted average: lower avgSpofScore = higher gauge value (safer team)
   - Formula: `Math.round(100 - (avgTeamSpof / 6) * 100)` so score 0 = 100 (safest), score 6 = 0 (riskiest)

Create `lib/teamDashboard/spofHelpers.ts`:

1. Define `SpofMemberFilter` type: `"highestRisk" | "lowestRisk" | "mostRepos" | "leastRepos" | "mostCritical" | "mostHealthy"`

2. Create `SPOF_MEMBER_FILTER_TABS` array with labels: "Highest Risk", "Lowest Risk", "Most Repos", "Least Repos", "Most Critical", "Most Healthy"

3. Create `spofMemberSortFunction(rows, filter)` following the Performance tab sort pattern:
   - `highestRisk`: sort by avgSpofScore descending
   - `lowestRisk`: sort by avgSpofScore ascending
   - `mostRepos`: sort by repoCount descending
   - `leastRepos`: sort by repoCount ascending
   - `mostCritical`: sort by repoHealthCritical descending
   - `mostHealthy`: sort by repoHealthHealthy descending

4. Create `getSpofInsights(members: MemberSpofRow[])` returning `ChartInsight[]`:
   - 3-4 insights about member SPOF risk
   - Reference specific member names (e.g., "David Kim has the highest SPOF risk with an average score of 3.8")
   - Include repo health insight (e.g., "65% of Alice Chen's repositories are in healthy state")
   - Use deterministic selection (sort-based, not random)
  </action>
  <verify>
    Run `npx tsc --noEmit` to confirm no type errors in new files.
  </verify>
  <done>
    spofMockData.ts exports MemberSpofRow type, getMemberSpofData, getMemberSpofDataPoints, calculateTeamSpofGaugeValue. spofHelpers.ts exports SpofMemberFilter type, SPOF_MEMBER_FILTER_TABS, spofMemberSortFunction, and getSpofInsights. SpofDataPoint[] output matches SpofDistributionChart expected input.
  </done>
</task>

<task type="auto">
  <name>Task 2: Compose SPOF tab page with all components</name>
  <files>
    app/org/[orgId]/team/[teamId]/spof/page.tsx
  </files>
  <action>
Replace the placeholder SPOF page with the full implementation. Follow the org SPOF page layout (`app/org/[orgId]/spof/page.tsx`):

1. Add `"use client"` directive at top.

2. Import all required components:
   - `D3Gauge` from `@/components/dashboard/D3Gauge`
   - `SpofDistributionChart` from `@/components/dashboard/SpofDistributionChart`
   - `RepoHealthBar` from `@/components/dashboard/RepoHealthBar`
   - `BaseTeamsTable, BaseTeamsTableColumn` from `@/components/dashboard/BaseTeamsTable`
   - `DashboardSection` from `@/components/dashboard/DashboardSection`
   - `ChartInsights` from `@/components/dashboard/ChartInsights`
   - `Badge` from `@/components/shared/Badge`
   - `TeamAvatar` from `@/components/shared/TeamAvatar`
   - `TooltipProvider` from `@/components/ui/tooltip`
   - Mock data and helpers from `@/lib/teamDashboard/spofMockData` and `spofHelpers`
   - `getGaugeColor, getPerformanceGaugeLabel` from `@/lib/orgDashboard/utils`

3. Define `SPOF_MEMBER_COLUMNS` following the Performance tab column pattern:
   - Rank column (w-14, bold for top 3)
   - Member column (TeamAvatar + name, with memberColor dot indicator)
   - SPOF Score column (formatted to 1 decimal, color-coded: green < 1.5, yellow 1.5-3, red > 3)
   - Repos column (repoCount number)
   - High Risk column (highRiskCount, red text)
   - Repo Health column (3-segment mini bar: healthy green, attention yellow, critical red)

4. Page component `TeamSpofPage`:
   - `useParams()` to get teamId
   - State: `activeFilter` (SpofMemberFilter, default "highestRisk"), `visibleMembers` (Record<string, boolean>)
   - Data: `useMemo` for `getMemberSpofData(teamId)`, `getMemberSpofDataPoints(members)`, `calculateTeamSpofGaugeValue(members)`, insights
   - Initialize `visibleMembers` with all members visible
   - `handleVisibilityChange` callback

5. Render layout mirroring org SPOF page exactly:
   - Section 1: "SPOF Owner Distribution" with `DashboardSection`
     - Flex row: `D3Gauge` (min-w-[280px] max-w-[50%]) | `ChartInsights` (flex-1 min-w-[280px])
     - Below: `SpofDistributionChart` with `data` (member SPOF data points), `visibleTeams` (member visibility), `showNormalFit`
   - Section 2: "Repository Health Distribution" with `DashboardSection`
     - `RepoHealthBar` component — check if it accepts data props. If it uses internal data, pass member repo health data if supported. If it only renders static/internal data, include it as-is for layout consistency.
   - Section 3: "Team Members" with `DashboardSection`, filter Badge buttons in action slot
     - `BaseTeamsTable<MemberSpofRow, SpofMemberFilter>` with SPOF columns, filter tabs, sort function

6. Wrap entire return in `TooltipProvider`.

7. D3Gauge props: `value={gaugeValue}`, `label={getPerformanceGaugeLabel(gaugeValue)}`, `labelColor={getGaugeColor(gaugeValue)}`, `valueDisplay={\`${gaugeValue}/100\`}` — matching org SPOF page pattern exactly.

8. Filter badges rendered outside BaseTeamsTable in DashboardSection action slot (matching org Design page pattern).
  </action>
  <verify>
    Run `npx tsc --noEmit` to confirm no type errors. Run `npm run build` to verify page compiles. Navigate to `/org/test-org/team/test-team/spof` in browser to verify page renders.
  </verify>
  <done>
    SPOF tab renders with: D3Gauge showing team SPOF risk score, SpofDistributionChart showing member SPOF distribution histogram, RepoHealthBar showing repository health, member table with SPOF score/repos/risk columns, filter tabs sorting members by 6 criteria, ChartInsights showing member-specific SPOF risk insights.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `npm run build` completes successfully
3. SPOF tab page renders at team dashboard URL
4. D3Gauge shows team SPOF risk score (0-100)
5. SpofDistributionChart receives member-level SpofDataPoint[] data with member names in team field
6. RepoHealthBar renders (with member data if props allow, static otherwise)
7. BaseTeamsTable renders all members with SPOF-specific columns
8. Filter tabs change table sort order
9. ChartInsights shows member-specific SPOF insights
</verification>

<success_criteria>
- SPOF-01: SpofDistributionChart renders with member SPOF score distribution
- SPOF-02: RepoHealthBar renders repository health distribution
- SPOF-03: BaseTeamsTable shows members with SPOF score, repos, risk level, repo health columns
- SPOF-04: 6 filter tabs (Highest/Lowest Risk, Most/Least Repos, Most Critical, Most Healthy) sort correctly
- SPOF-05: ChartInsights panel shows 3-4 member-specific SPOF risk insights
</success_criteria>

<output>
After completion, create `.planning/phases/04-remaining-tabs/04-03-SUMMARY.md`
</output>
